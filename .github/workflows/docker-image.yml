name: Build, Test and Manage Docker Image (arm64 支持)

on:
  workflow_dispatch:
    inputs:
      push:
        description: '是否推送到 Docker Hub (true/false)'
        required: true
        default: 'false'

env:
  REGISTRY: docker.io
  IMAGE_NAME: goosews/cups

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 安装 docker-compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose

      - name: 配置 Docker Buildx（支持多架构）
        uses: docker/setup-buildx-action@v3

      - name: 构建 arm64 镜像（通过 buildx 交叉编译）
        run: |
          docker-compose build --no-cache --force-rm
          # 用 buildx 确保架构标记正确
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:arm64-latest

      - name: 导出 arm64 镜像到 tar 包
        run: docker save -o ${{ env.IMAGE_NAME }}-arm64.tar ${{ env.IMAGE_NAME }}:arm64-latest

      - name: 保存镜像到 Artifacts（保留 3 天）
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-arm64
          path: ${{ env.IMAGE_NAME }}-arm64.tar
          retention-days: 3

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: 移除 compose 中的 USB 设备配置
        run: |
          grep -Ev "^    (devices:|  - \"/dev/bus/usb:/dev/bus/usb\")" "docker-compose.yaml" > "docker-compose-no-usb.yaml"
          mv "docker-compose-no-usb.yaml" "docker-compose.yaml"

      - name: 启动容器测试（本地模拟 arm64 运行）
        run: |
          # 加载之前构建的 arm64 镜像
          docker load -i ${{ env.IMAGE_NAME }}-arm64.tar
          # 启动容器
          docker-compose up -d
          sleep 10
          # 验证容器运行状态
          if ! docker ps | grep -q ${{ env.IMAGE_NAME }}; then
            echo "容器启动失败"
            exit 1
          fi
